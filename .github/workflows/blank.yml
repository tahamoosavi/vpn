# .github/workflows/wireguard-vpn.yml
name: WireGuard VPN Endpoint

on:
  workflow_dispatch:
    inputs:
      timeout_minutes:
        description: 'How long to keep VPN alive (minutes)'
        required: true
        default: '60'
        type: choice
        options:
          - 30
          - 60
          - 180
          - 360

jobs:
  deploy-wireguard:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.timeout_minutes }}
    
    steps:
      - name: Install WireGuard
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools qrencode

      - name: Generate WireGuard keys
        run: |
          mkdir -p wireguard-keys
          cd wireguard-keys
          
          wg genkey | tee server_private.key | wg pubkey > server_public.key
          wg genkey | tee client_private.key | wg pubkey > client_public.key
          wg genpsk > preshared.key
          chmod 644 *.key
          cd ..

      - name: Setup WireGuard server
        run: |
          INTERFACE=$(ip route | grep default | awk '{print $5}')
          PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip)
          
          # Create server config
          sudo tee /etc/wireguard/wg0.conf > /dev/null << EOF
          [Interface]
          Address = 10.8.0.1/24
          PrivateKey = $(cat wireguard-keys/server_private.key)
          ListenPort = 51820
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o $INTERFACE -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o $INTERFACE -j MASQUERADE

          [Peer]
          PublicKey = $(cat wireguard-keys/client_public.key)
          PresharedKey = $(cat wireguard-keys/preshared.key)
          AllowedIPs = 10.8.0.2/32
          EOF
          
          sudo chmod 600 /etc/wireguard/wg0.conf

      - name: Start WireGuard and display connection info
        run: |
          sudo wg-quick up wg0
          
          # Display connection info
          echo "========================================="
          echo "ðŸš€ WireGuard VPN Server is LIVE!"
          echo "========================================="
          echo ""
          echo "ðŸ“¡ Server Public IP: $(curl -s ifconfig.me)"
          echo "ðŸ”Œ Port: 51820"
          echo "â° Will run for: ${{ github.event.inputs.timeout_minutes }} minutes"
          echo ""
          
          # Create and display client config
          cat > client.conf << EOF
          [Interface]
          Address = 10.8.0.2/24
          PrivateKey = $(cat wireguard-keys/client_private.key)
          DNS = 1.1.1.1, 8.8.8.8

          [Peer]
          PublicKey = $(cat wireguard-keys/server_public.key)
          PresharedKey = $(cat wireguard-keys/preshared.key)
          Endpoint = $(curl -s ifconfig.me):51820
          AllowedIPs = 0.0.0.0/0
          PersistentKeepalive = 25
          EOF
          
          echo "ðŸ“‹ CLIENT CONFIGURATION:"
          echo "========================================="
          cat client.conf
          echo ""
          
          # Show QR code if qrencode installed
          echo "ðŸ“± QR Code (for mobile clients):"
          qrencode -t ansiutf8 < client.conf 2>/dev/null || echo "QR code not available"
          echo ""
          
          # Test if port is accessible
          echo "ðŸ” Testing port accessibility..."
          timeout 2 bash -c "echo >/dev/tcp/$(curl -s ifconfig.me)/51820" 2>/dev/null && \
            echo "âœ… Port appears accessible" || \
            echo "âš ï¸  Port may be blocked (common on GitHub runners)"

      # ========== CRITICAL: KEEP-ALIVE SECTION ==========
      - name: Keep VPN alive (this step runs until timeout)
        run: |
          echo "ðŸ”„ VPN server is running. Will stop in ${{ github.event.inputs.timeout_minutes }} minutes..."
          echo "Press Ctrl+C in workflow logs to stop early"
          
          # Create a health check endpoint that keeps the job alive
          # Install a simple HTTP server to prove it's working
          sudo apt-get install -y python3
          
          # Create a simple status page
          cat > /tmp/vpn-status.html << EOF
          <html><body>
          <h1>GitHub Actions WireGuard VPN</h1>
          <p>Status: <span style="color:green">ðŸŸ¢ RUNNING</span></p>
          <p>Uptime: <span id="uptime">0</span> seconds</p>
          <p>Client IP: 10.8.0.2</p>
          <p>Server IP: $(curl -s ifconfig.me)</p>
          <script>
            let start = Date.now();
            setInterval(() => {
              document.getElementById('uptime').textContent = 
                Math.floor((Date.now() - start)/1000);
            }, 1000);
          </script>
          </body></html>
          EOF
          
          # Start a simple HTTP server in background
          python3 -m http.server 8080 --directory /tmp &
          HTTP_PID=$!
          
          # Keep-alive loop with periodic status updates
          COUNTER=0
          TIMEOUT_MINUTES=${{ github.event.inputs.timeout_minutes }}
          TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
          
          while [ $COUNTER -lt $TIMEOUT_SECONDS ]; do
            # Show status every 30 seconds
            if [ $((COUNTER % 30)) -eq 0 ]; then
              echo "â° VPN uptime: ${COUNTER}s / ${TIMEOUT_SECONDS}s"
              sudo wg show
              echo "----------------------------------------"
            fi
            
            sleep 1
            COUNTER=$((COUNTER + 1))
          done
          
          # Cleanup
          kill $HTTP_PID 2>/dev/null || true
          echo "â¹ï¸  Timeout reached, stopping VPN..."

      - name: Cleanup (always runs)
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          sudo wg-quick down wg0 2>/dev/null || true
          sudo rm -f /etc/wireguard/wg0.conf
          echo "âœ… VPN stopped"

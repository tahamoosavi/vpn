# .github/workflows/wireguard-vpn.yml
name: WireGuard VPN Endpoint

on:
  workflow_dispatch:

jobs:
  deploy-wireguard:
    runs-on: ubuntu-latest
    steps:
      - name: Install WireGuard
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools qrencode

      - name: Generate WireGuard keys (with proper permissions)
        run: |
          # Generate keys in workspace directory (no permission issues)
          mkdir -p wireguard-keys
          cd wireguard-keys
          
          # Server keys
          wg genkey | tee server_private.key | wg pubkey > server_public.key
          
          # Client keys  
          wg genkey | tee client_private.key | wg pubkey > client_public.key
          
          # Preshared key
          wg genpsk > preshared.key
          
          # Set readable permissions
          chmod 644 *.key
          
          # Return to workspace root
          cd ..

      - name: Create and start WireGuard config (using sudo properly)
        run: |
          # Get network interface
          INTERFACE=$(ip route | grep default | awk '{print $5}')
          
          # Create config content FIRST in workspace
          cat > wireguard-config.conf << EOF
          [Interface]
          Address = 10.8.0.1/24
          PrivateKey = $(cat wireguard-keys/server_private.key)
          ListenPort = 51820
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o $INTERFACE -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o $INTERFACE -j MASQUERADE
          SaveConfig = false

          [Peer]
          PublicKey = $(cat wireguard-keys/client_public.key)
          PresharedKey = $(cat wireguard-keys/preshared.key)
          AllowedIPs = 10.8.0.2/32
          EOF
          
          # NOW copy to /etc/wireguard with sudo
          sudo mkdir -p /etc/wireguard
          sudo cp wireguard-config.conf /etc/wireguard/wg0.conf
          
          # Set correct permissions
          sudo chmod 600 /etc/wireguard/wg0.conf

      - name: Start WireGuard interface
        run: |
          sudo wg-quick up wg0 || echo "Failed to start WireGuard (may already be running)"
          
          # Verify it's running
          sudo wg show

      - name: Create client configuration
        run: |
          # Get public IP
          PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || echo "IP_FETCH_FAILED")
          
          # Create client config
          cat > client.conf << EOF
          [Interface]
          Address = 10.8.0.2/24
          PrivateKey = $(cat wireguard-keys/client_private.key)
          DNS = 1.1.1.1, 8.8.8.8

          [Peer]
          PublicKey = $(cat wireguard-keys/server_public.key)
          PresharedKey = $(cat wireguard-keys/preshared.key)
          Endpoint = $PUBLIC_IP:51820
          AllowedIPs = 0.0.0.0/0
          PersistentKeepalive = 25
          EOF
          
          echo "=== Client Configuration ==="
          echo ""
          cat client.conf
          echo ""
          echo "=== QR Code ==="
          qrencode -t ansiutf8 < client.conf 2>/dev/null || echo "Install qrencode for QR code"

      - name: Keep alive and display info
        run: |
          echo "‚úÖ WireGuard VPN server is running on GitHub Actions runner!"
          echo "üì° Public IP: $(curl -s ifconfig.me || echo 'unknown')"
          echo "üîë Port: 51820"
          echo ""
          echo "üìã To connect from your Linux machine:"
          echo "1. Copy the ENTIRE client configuration above"
          echo "2. On your Linux machine: sudo nano /etc/wireguard/wg0-client.conf"
          echo "3. Paste the config and save (Ctrl+X, Y, Enter)"
          echo "4. Connect: sudo wg-quick up wg0-client"
          echo ""
          echo "‚ö†Ô∏è  This workflow will run for ~6 hours max"
          echo "‚ö†Ô∏è  GitHub may block inbound connections (use self-hosted runner if needed)"

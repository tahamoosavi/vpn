# .github/workflows/wireguard-vpn.yml
name: WireGuard VPN Endpoint

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  deploy-wireguard:
    runs-on: ubuntu-latest
    # Remove the problematic timeout-minutes from here
    
    steps:
      - name: Install WireGuard
        run: |
          sudo apt-get update
          sudo apt-get install -y wireguard-tools qrencode curl

      - name: Generate WireGuard keys
        run: |
          mkdir -p wireguard-keys
          cd wireguard-keys
          wg genkey | tee server_private.key | wg pubkey > server_public.key
          wg genkey | tee client_private.key | wg pubkey > client_public.key
          wg genpsk > preshared.key
          chmod 644 *.key
          cd ..

      - name: Setup WireGuard server
        run: |
          INTERFACE=$(ip route | grep default | awk '{print $5}')
          PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || echo "AUTO_DETECT_FAILED")
          
          sudo tee /etc/wireguard/wg0.conf > /dev/null << EOF
          [Interface]
          Address = 10.8.0.1/24
          PrivateKey = $(cat wireguard-keys/server_private.key)
          ListenPort = 51820
          PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o $INTERFACE -j MASQUERADE
          PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o $INTERFACE -j MASQUERADE

          [Peer]
          PublicKey = $(cat wireguard-keys/client_public.key)
          PresharedKey = $(cat wireguard-keys/preshared.key)
          AllowedIPs = 10.8.0.2/32
          EOF
          
          sudo chmod 600 /etc/wireguard/wg0.conf
          sudo wg-quick up wg0

      - name: Display connection information
        run: |
          PUBLIC_IP=$(curl -s ifconfig.me || echo "IP_FETCH_FAILED")
          
          echo "=========================================="
          echo "üöÄ WIREGUARD VPN READY TO CONNECT"
          echo "=========================================="
          echo "Server IP: $PUBLIC_IP"
          echo "Port: 51820"
          echo ""
          
          # Create client config
          cat > client.conf << EOF
          [Interface]
          Address = 10.8.0.2/24
          PrivateKey = $(cat wireguard-keys/client_private.key)
          DNS = 1.1.1.1, 8.8.8.8

          [Peer]
          PublicKey = $(cat wireguard-keys/server_public.key)
          PresharedKey = $(cat wireguard-keys/preshared.key)
          Endpoint = $PUBLIC_IP:51820
          AllowedIPs = 0.0.0.0/0
          PersistentKeepalive = 25
          EOF
          
          echo "üìã CLIENT CONFIGURATION (copy ALL of this):"
          echo "=========================================="
          cat client.conf
          echo ""
          
          # QR code
          echo "üì± QR Code:"
          qrencode -t ansiutf8 < client.conf 2>/dev/null || echo "Install qrencode for QR code"
          
          # Test port
          echo ""
          echo "üîç Test from YOUR machine with:"
          echo "nc -vzu $PUBLIC_IP 51820"
          echo ""
          echo "‚ö†Ô∏è  If 'Connection timed out', GitHub blocks inbound connections."

      # ========== SIMPLE KEEP-ALIVE ==========
      - name: Keep VPN alive (interactive)
        run: |
          echo "üîÑ VPN server is running..."
          echo "This workflow will auto-stop after 360 minutes (6h max)"
          echo ""
          echo "‚è∞ Time remaining: 360 minutes"
          echo "Press 'Cancel workflow' in GitHub UI to stop early"
          echo ""
          echo "To connect from your Linux machine:"
          echo "1. Copy client config from above"
          echo "2. Save to /etc/wireguard/github-vpn.conf"
          echo "3. Run: sudo wg-quick up github-vpn"
          echo ""
          
          # Simple countdown display
          TOTAL_MINUTES=360
          for ((minute=1; minute<=TOTAL_MINUTES; minute++)); do
            remaining=$((TOTAL_MINUTES - minute))
            
            # Show status every 5 minutes
            if [ $((minute % 5)) -eq 0 ]; then
              echo "[$(date '+%H:%M:%S')] VPN uptime: ${minute}m (${remaining}m remaining)"
              # Show WireGuard status
              echo "WireGuard status:"
              sudo wg show
              echo "--------------------------------"
            fi
            
            sleep 60  # Sleep for 1 minute
          done
          
          echo "‚èπÔ∏è  6-hour limit reached, stopping VPN..."

      - name: Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up..."
          sudo wg-quick down wg0 2>/dev/null || true
          echo "‚úÖ VPN stopped"

name: Tailscale Exit Node

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  tailscale-exit-node:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Tailscale and SSH server
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo apt-get update
          sudo apt-get install -y openssh-server

      - name: Start Tailscale and get login link
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Validate required secrets
          if [ -z "$TAILSCALE_AUTHKEY" ]; then
            echo "ERROR: TAILSCALE_AUTHKEY secret is not set"
            echo "Please add TAILSCALE_AUTHKEY to your repository secrets"
            exit 1
          fi
          
          if [ -z "$SSH_PASSWORD" ]; then
            echo "ERROR: SSH_PASSWORD secret is not set"
            echo "Please add SSH_PASSWORD to your repository secrets"
            exit 1
          fi
          
          echo "Starting Tailscale with SSH enabled..."
          sudo tailscale up --advertise-exit-node --ssh --authkey="$TAILSCALE_AUTHKEY"
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to authenticate with Tailscale"
            echo "Please check your TAILSCALE_AUTHKEY is valid"
            exit 1
          fi
          
          echo "Tailscale started successfully"

      - name: Configure SSH
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Start SSH service
          sudo systemctl start ssh
          sudo systemctl enable ssh
          
          # Set user password from secret
          echo "runner:$SSH_PASSWORD" | sudo chpasswd
          
          # Allow password authentication
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          
          echo "SSH configured successfully"

      - name: Verify Tailscale status
        run: |
          sleep 5
          echo "==================================="
          echo "TAILSCALE EXIT NODE RUNNING"
          echo "==================================="
          echo "Status: Active"
          echo "SSH: Enabled"
          echo "Exit Node: Advertised"
          echo ""
          echo "Connection Info:"
          echo "  - Check Tailscale admin console for machine name"
          echo "  - SSH using: ssh runner@<machine-name>"
          echo "  - Or use Tailscale IP from admin console"
          echo ""
          echo "Next steps:"
          echo "1. Go to https://login.tailscale.com/admin/machines"
          echo "2. Find this machine in the list"
          echo "3. Enable 'Use as exit node' if needed"
          echo "4. Note the machine name/IP for SSH access"
          echo "==================================="

      - name: Keep runner alive
        run: |
          echo "Tailscale exit node is running..."
          echo "This workflow will run for up to 6 hours (GitHub's max)"
          # Keep the workflow running
          sleep 21600  # 6 hours

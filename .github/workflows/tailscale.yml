name: Tailscale Exit Node

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  tailscale-exit-node:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Tailscale and SSH server
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo apt-get update
          
          # Install SSH server
          sudo apt-get install -y openssh-server
          
          # Install lightweight desktop environment (XFCE) and VNC server
          echo "Installing desktop environment..."
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            tightvncserver \
            dbus-x11 \
            firefox \
            xauth \
            x11-xserver-utils \
            xfonts-base \
            xfonts-75dpi \
            xfonts-100dpi \
            xfonts-scalable \
            fontconfig \
            fonts-dejavu-core \
            --no-install-recommends
          
          echo "Desktop environment installed"

      - name: Start Tailscale and get login link
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Validate required secrets
          if [ -z "$TAILSCALE_AUTHKEY" ]; then
            echo "ERROR: TAILSCALE_AUTHKEY secret is not set"
            echo "Please add TAILSCALE_AUTHKEY to your repository secrets"
            exit 1
          fi
          
          if [ -z "$SSH_PASSWORD" ]; then
            echo "ERROR: SSH_PASSWORD secret is not set"
            echo "Please add SSH_PASSWORD to your repository secrets"
            exit 1
          fi
          
          echo "Starting Tailscale with SSH enabled..."
          sudo tailscale up --advertise-exit-node --ssh --authkey="$TAILSCALE_AUTHKEY"
          
          if [ $? -ne 0 ]; then
            echo "ERROR: Failed to authenticate with Tailscale"
            echo "Please check your TAILSCALE_AUTHKEY is valid"
            exit 1
          fi
          
          echo "Tailscale started successfully"

      - name: Configure SSH
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          # Start SSH service
          sudo systemctl start ssh
          sudo systemctl enable ssh
          
          # Set user password from secret
          echo "runner:$SSH_PASSWORD" | sudo chpasswd
          
          # Allow password authentication
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          
          echo "SSH configured successfully"

      - name: Configure VNC Server
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          set -euo pipefail

          # Create VNC directory
          mkdir -p "$HOME/.vnc"
          chmod 700 "$HOME/.vnc"

          # Set VNC password non-interactively and answer 'n' to view-only prompt
          printf "%s\n%s\nn\n" "$SSH_PASSWORD" "$SSH_PASSWORD" | vncpasswd

          # Ensure .Xauthority exists and has an entry for display :1
          # Generate a temporary MIT-MAGIC-COOKIE and add it for display :1
          COOKIE=$(mcookie)
          touch "$HOME/.Xauthority"
          xauth add :1 . "$COOKIE"
          # Export XAUTHORITY so Xvnc picks it up
          export XAUTHORITY="$HOME/.Xauthority"

          # Create xstartup file for XFCE (use exec to replace the shell)
          cat > "$HOME/.vnc/xstartup" << 'EOF'
          #!/bin/bash
          xrdb $HOME/.Xresources
          # startxfce4 may background itself; use exec to ensure it is the session process
          exec startxfce4
          EOF
          chmod +x "$HOME/.vnc/xstartup"

          # Start VNC server on display :1 (port 5901)
          # Use -localhost no so remote clients can connect directly to the advertised IP
          vncserver :1 -geometry 1920x1080 -depth 24 -localhost no

          echo "VNC server started on display :1 (port 5901)"

      - name: Verify Tailscale status
        run: |
          sleep 5
          echo "==================================="
          echo "TAILSCALE EXIT NODE RUNNING"
          echo "==================================="
          echo "Status: Active"
          echo "SSH: Enabled"
          echo "VNC: Enabled (Display :1, Port 5901)"
          echo "Desktop: XFCE4"
          echo "Exit Node: Advertised"
          echo ""
          echo "Connection Info:"
          echo "  - Check Tailscale admin console for machine name"
          echo "  - SSH: ssh runner@<machine-name>"
          echo "  - VNC: <machine-name>:5901 or <tailscale-ip>:5901"
          echo "  - Password: (from SSH_PASSWORD secret)"
          echo ""
          echo "VNC Clients:"
          echo "  - TigerVNC Viewer (recommended)"
          echo "  - RealVNC Viewer"
          echo "  - Any VNC client supporting VNC protocol"
          echo ""
          echo "Next steps:"
          echo "1. Go to https://login.tailscale.com/admin/machines"
          echo "2. Find this machine in the list"
          echo "3. Note the machine name/IP"
          echo "4. Connect via VNC client to <machine-name>:5901"
          echo "5. Enable 'Use as exit node' if needed"
          echo "==================================="

      - name: Keep runner alive
        run: |
          echo "Tailscale exit node is running..."
          echo "This workflow will run for up to 6 hours (GitHub's max)"
          # Keep the workflow running
          sleep 21600  # 6 hours

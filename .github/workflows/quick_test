name: WireGuard Quick Test
on: workflow_dispatch
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Setup WireGuard
        run: |
          sudo apt install -y wireguard-tools
          mkdir -p /tmp/wg
          cd /tmp/wg
          wg genkey | tee server.key | wg pubkey > server.pub
          wg genkey | tee client.key | wg pubkey > client.pub
          
          # Server config
          sudo tee /etc/wireguard/wg0.conf << EOF
          [Interface]
          Address = 10.8.0.1/24
          PrivateKey = $(cat server.key)
          ListenPort = 51820
          PostUp = sysctl -w net.ipv4.ip_forward=1
          
          [Peer]
          PublicKey = $(cat client.pub)
          AllowedIPs = 10.8.0.2/32
          EOF
          
          sudo wg-quick up wg0
          
      - name: Wait for connection
        run: |
          echo "VPN ready at: $(curl -s ifconfig.me):51820"
          echo ""
          echo "Client config:"
          cat << EOF
          [Interface]
          Address = 10.8.0.2/24
          PrivateKey = $(cat /tmp/wg/client.key)
          
          [Peer]
          PublicKey = $(cat /tmp/wg/server.pub)
          Endpoint = $(curl -s ifconfig.me):51820
          AllowedIPs = 10.8.0.0/24
          EOF
          
          # Keep alive
          sleep 300
